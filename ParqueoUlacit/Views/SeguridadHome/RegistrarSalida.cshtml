@model ParqueoUlacit.Models.Vehiculo
@{
    ViewBag.Title = "Registrar Salida";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container my-5">
    <!-- Título de la sección -->
    <div class="row mb-4">
        <div class="col">
            <h2 class="section-title">Registrar Salida de Vehículo</h2>
            <div class="section-divider"></div>
            <p class="text-muted mt-3">Control de salidas para el parqueo: <strong>@ViewBag.NombreParqueo</strong></p>
        </div>
    </div>

    @if (Model != null)
    {
        <!-- Mostrar detalles del vehículo si se ha seleccionado uno -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="form-container">
                    <div class="form-header mb-4">
                        <h4 class="mb-0"><i class="bi bi-box-arrow-right me-2"></i>Confirmar Salida del Vehículo</h4>
                    </div>

                    <div class="alert alert-warning d-flex align-items-center mb-4">
                        <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
                        <div><strong>¡Atención!</strong> Está a punto de registrar la salida del siguiente vehículo del parqueo.</div>
                    </div>

                    <div class="table-responsive mb-4">
                        <table class="table">
                            <tbody>
                                <tr class="border-bottom">
                                    <th class="bg-light rounded-start py-3" style="width: 30%">Número de Placa</th>
                                    <td class="py-3"><span class="fw-bold">@Model.NumeroPlaca</span></td>
                                </tr>
                                <tr class="border-bottom">
                                    <th class="bg-light py-3">Tipo de Vehículo</th>
                                    <td class="py-3">
                                        @if (Model.Tipo == "Automovil")
                                        {
                                            <span><i class="bi bi-car-front me-1"></i> Automóvil</span>
                                        }
                                        else if (Model.Tipo == "Moto")
                                        {
                                            <span><i class="bi bi-bicycle me-1"></i> Moto</span>
                                        }
                                        else
                                        {
                                            <span>@Model.Tipo</span>
                                        }
                                    </td>
                                </tr>
                                <tr class="border-bottom">
                                    <th class="bg-light py-3">Marca</th>
                                    <td class="py-3">@Model.Marca</td>
                                </tr>
                                <tr class="border-bottom">
                                    <th class="bg-light py-3">Color</th>
                                    <td class="py-3">@Model.Color</td>
                                </tr>
                                <tr class="border-bottom">
                                    <th class="bg-light py-3">Usuario</th>
                                    <td class="py-3">
                                        @if (Model.Usuario != null)
                                        {
                                            <span><i class="bi bi-person me-1"></i> @Model.Usuario.Nombre</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted fst-italic">No asignado</span>
                                        }
                                    </td>
                                </tr>
                                <tr>
                                    <th class="bg-light rounded-end py-3">Espacio Ley 7600</th>
                                    <td class="py-3">
                                        @if (Model.UsaEspacioLey7600 == true)
                                        {
                                            <span class="badge rounded-pill bg-white border border-info text-info py-2 px-3">
                                                <i class="bi bi-person-wheelchair me-1"></i>Sí
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="badge rounded-pill bg-white border border-secondary text-secondary py-2 px-3">
                                                <i class="bi bi-x-circle me-1"></i>No
                                            </span>
                                        }
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    @using (Html.BeginForm())
                    {
                        @Html.AntiForgeryToken()
                        @Html.HiddenFor(model => model.VehiculoID)

                        <div class="info-box p-4 mb-4 text-center">
                            <p class="mb-0">Una vez registrada la salida, el vehículo ya no aparecerá en la lista de vehículos actuales del parqueo.</p>
                        </div>

                        <div class="form-actions">
                            <a href="@Url.Action("VehiculosActuales", "SeguridadHome")" class="pulse-button-inverse">
                                <span>Cancelar</span>
                                <i class="bi bi-x-circle"></i>
                            </a>
                            <button type="submit" class="pulse-button">
                                <span>Confirmar Salida</span>
                                <i class="bi bi-box-arrow-right"></i>
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Formulario para ingresar placa directamente si no hay vehículo seleccionado -->
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <div class="form-container">
                    <div class="form-header mb-4">
                        <h4 class="mb-0"><i class="bi bi-box-arrow-right me-2"></i>Registrar Salida por Número de Placa</h4>
                    </div>

                    @if (ViewBag.MensajeError != null)
                    {
                        <div class="alert alert-danger d-flex align-items-center mb-4">
                            <i class="bi bi-exclamation-triangle-fill me-2 fs-4"></i>
                            <div><strong>Error:</strong> @ViewBag.MensajeError</div>
                        </div>
                    }

                    <div class="info-box p-4 mb-4">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-info-circle-fill me-3 fs-4"></i>
                            <p class="mb-0">Ingrese el número de placa del vehículo para registrar su salida del parqueo.</p>
                        </div>
                    </div>

                    @using (Html.BeginForm("RegistrarSalidaPorPlaca", "SeguridadHome", FormMethod.Post, new { @class = "mb-4 needs-validation", novalidate = "novalidate" }))
                    {
                        @Html.AntiForgeryToken()

                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="form-group">
                                    <label for="numeroPlaca" class="form-label">Número de Placa</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="numeroPlaca" name="numeroPlaca"
                                               placeholder="Ejemplo: ABC-123 o 123-456" required
                                               value="@(ViewBag.NumeroPlaca != null ? ViewBag.NumeroPlaca : "")" />
                                    </div>
                                    <small class="form-text text-muted">Ingrese el número de placa completo del vehículo (formato ABC-123 o 123-456).</small>
                                    <div id="placaError" class="text-danger mt-2" style="display: none;"></div>
                                </div>
                            </div>
                        </div>

                        <div class="form-actions">
                            <a href="@Url.Action("Index", "SeguridadHome")" class="pulse-button-inverse">
                                <span>Volver al Panel</span>
                                <i class="bi bi-arrow-left"></i>
                            </a>
                            <button type="submit" class="pulse-button">
                                <span>Registrar Salida</span>
                                <i class="bi bi-box-arrow-right"></i>
                            </button>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function () {
            // Convertir el input de placa a mayúsculas
            $('#numeroPlaca').keyup(function () {
                this.value = this.value.toUpperCase();
            });

            // Función para validar el formato de la placa
            function validateLicensePlate(plate) {
                // Formato tipo letras-números (ABC-123)
                var letterNumberFormat = /^[A-Z]{3}-[0-9]{3,4}$/;

                // Formato tipo números-números (123-456)
                var numberNumberFormat = /^[0-9]{3}-[0-9]{3}$/;

                return letterNumberFormat.test(plate) || numberNumberFormat.test(plate);
            }

            // Formatear la placa (ejemplo: ABC-123 o 123-456)
            $('#numeroPlaca').on('input', function () {
                var val = this.value;
                var errorElement = $('#placaError');

                // Eliminar caracteres no válidos
                val = val.replace(/[^A-Z0-9\-]/g, '');

                // Si ya hay un guión, asegurarse de que solo haya uno
                if (val.indexOf('-') !== -1) {
                    var parts = val.split('-');
                    if (parts.length > 2) {
                        val = parts[0] + '-' + parts.slice(1).join('');
                    }
                }
                // Si no hay guión y ya hay 3 caracteres, agregar automáticamente
                else if (val.length === 3) {
                    val = val + '-';
                }

                this.value = val;

                // Validar formato y mostrar feedback
                if (val.length > 5) { // Solo validar cuando haya contenido suficiente
                    if (validateLicensePlate(val)) {
                        errorElement.hide();
                        $(this).removeClass('is-invalid').addClass('is-valid');
                    } else {
                        errorElement.text('La placa debe tener formato ABC-123 o 123-456').show();
                        $(this).removeClass('is-valid').addClass('is-invalid');
                    }
                } else {
                    errorElement.hide();
                    $(this).removeClass('is-valid is-invalid');
                }
            });

            // Validar el formato de la placa antes de enviar el formulario
            $('form').submit(function (e) {
                var placa = $('#numeroPlaca').val();
                var errorElement = $('#placaError');

                if (placa && !validateLicensePlate(placa)) {
                    errorElement.text('La placa debe tener formato ABC-123 (tres letras, guión, números) o 123-456 (tres números, guión, tres números)').show();
                    $('#numeroPlaca').removeClass('is-valid').addClass('is-invalid');
                    e.preventDefault();
                    return false;
                }

                return true;
            });
        });
    </script>
}